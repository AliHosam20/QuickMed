<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - QuickMed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .appointment-container {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 2rem auto;
            max-width: 800px;
        }

        .appointment-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .appointment-form {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-book {
            background: linear-gradient(135deg, #27ae60, #229954);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-book:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .time-slot {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .time-slot:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .time-slot.selected {
            border-color: #27ae60;
            background: #27ae60;
            color: white;
        }

        .time-slot.unavailable {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .clinic-info {
            background: #f8f9fa;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .clinic-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .clinic-details {
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="appointment-container">
            <div class="appointment-header">
                <h1><i class="bi bi-calendar-plus me-2"></i>Book Appointment</h1>
                <p class="mb-0">Schedule your medical appointment</p>
            </div>

            <div class="appointment-form">
                <div class="success-message" id="successMessage">
                    <i class="bi bi-check-circle me-2"></i>
                    <span id="successText">Appointment booked successfully!</span>
                </div>

                <div class="error-message" id="errorMessage">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="errorText">An error occurred. Please try again.</span>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your appointment...</p>
                </div>

                <form id="appointmentForm">
                    <div class="clinic-info" id="clinicInfo">
                        <div class="clinic-name" id="clinicName">Select a clinic</div>
                        <div class="clinic-details" id="clinicDetails">Choose a clinic to see details</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clinicType" class="form-label">Clinic Type</label>
                                <select class="form-select" id="clinicType" required>
                                    <option value="">Select clinic type</option>
                                    <option value="dental">Dental Care</option>
                                    <option value="imaging">Imaging & Tests</option>
                                    <option value="general">General Medicine</option>
                                    <option value="emergency">Emergency Care</option>
                                    <option value="cardiology">Cardiology</option>
                                    <option value="orthopedic">Orthopedics</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="service" class="form-label">Service</label>
                                <select class="form-select" id="service" required>
                                    <option value="">Select service</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="appointmentDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="appointmentDate" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Time</label>
                                <div class="time-slots" id="timeSlots">
                                    <!-- Time slots will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label">Additional Notes (Optional)</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-book">
                        <i class="bi bi-calendar-check me-2"></i>Book Appointment
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Clinic data
        const clinicData = {
            dental: {
                name: "Smile Dental Center",
                details: "Tel Aviv, Dizengoff 123 • 03-123-4567",
                services: ["Teeth Cleaning", "Fillings", "Root Canal", "Braces", "Whitening", "Crowns"]
            },
            imaging: {
                name: "Advanced MRI Center",
                details: "Haifa, Rambam Medical Center • 04-456-7890",
                services: ["Brain MRI", "Spine MRI", "Joint MRI", "Cardiac MRI", "CT Scan", "Ultrasound"]
            },
            general: {
                name: "Family Health Center",
                details: "Jerusalem, Malha Mall • 02-222-3333",
                services: ["General Checkup", "Dermatology", "Ophthalmology", "ENT", "Cardiology", "Pediatrics"]
            },
            emergency: {
                name: "24/7 Emergency Clinic",
                details: "Eilat, Yoseftal Hospital • 03-999-0000",
                services: ["Emergency Care", "Trauma", "Accidents", "Urgent Surgery", "Ambulance", "Intensive Care"]
            },
            cardiology: {
                name: "Heart Care Center",
                details: "Ramat Gan, Sheba Medical Center • 03-530-3030",
                services: ["Echocardiogram", "Stress Test", "Cardiac Catheterization", "Pacemaker", "Heart Surgery", "Rehabilitation"]
            },
            orthopedic: {
                name: "Orthopedic Center",
                details: "Petah Tikva, Schneider Children's • 03-925-3611",
                services: ["Joint Replacement", "Sports Medicine", "Fracture Care", "Spine Surgery", "Physical Therapy", "Arthroscopy"]
            }
        };

        // Time slots
        const timeSlots = [
            "09:00", "09:30", "10:00", "10:30", "11:00", "11:30",
            "12:00", "12:30", "13:00", "13:30", "14:00", "14:30",
            "15:00", "15:30", "16:00", "16:30", "17:00", "17:30"
        ];

        let selectedTime = null;

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Check if coming from clinic profile
            const urlParams = new URLSearchParams(window.location.search);
            const clinicName = urlParams.get('clinic');
            const clinicType = urlParams.get('type');
            
            if (clinicName && clinicType) {
                // Load specific clinic data
                loadSpecificClinic(clinicName, clinicType);
            }

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('appointmentDate').value = tomorrow.toISOString().split('T')[0];

            // Generate time slots
            generateTimeSlots();

            // Add event listeners
            document.getElementById('clinicType').addEventListener('change', updateClinicInfo);
            document.getElementById('appointmentDate').addEventListener('change', generateTimeSlots);
            document.getElementById('appointmentForm').addEventListener('submit', bookAppointment);
        });

        // Function to load specific clinic data
        function loadSpecificClinic(clinicName, clinicType) {
            const clinicData = JSON.parse(localStorage.getItem('selectedClinic'));
            
            if (clinicData) {
                // Pre-fill clinic information
                document.getElementById('clinicName').textContent = clinicData.name;
                document.getElementById('clinicDetails').textContent = `${clinicData.location} • ${clinicData.phone}`;
                
                // Set clinic type
                document.getElementById('clinicType').value = clinicType;
                updateClinicInfo();
                
                // Pre-select first service
                if (clinicData.services && clinicData.services.length > 0) {
                    document.getElementById('service').value = clinicData.services[0];
                }
            }
        }

        function updateClinicInfo() {
            const clinicType = document.getElementById('clinicType').value;
            const serviceSelect = document.getElementById('service');
            
            if (clinicType && clinicData[clinicType]) {
                const clinic = clinicData[clinicType];
                document.getElementById('clinicName').textContent = clinic.name;
                document.getElementById('clinicDetails').textContent = clinic.details;
                
                // Update services
                serviceSelect.innerHTML = '<option value="">Select service</option>';
                clinic.services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service;
                    option.textContent = service;
                    serviceSelect.appendChild(option);
                });
            } else {
                document.getElementById('clinicName').textContent = 'Select a clinic';
                document.getElementById('clinicDetails').textContent = 'Choose a clinic to see details';
                serviceSelect.innerHTML = '<option value="">Select service</option>';
            }
        }

        function generateTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '';

            timeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.addEventListener('click', () => selectTimeSlot(slot, time));
                timeSlotsContainer.appendChild(slot);
            });
        }

        function selectTimeSlot(element, time) {
            // Remove selected class from all slots
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // Add selected class to clicked slot
            element.classList.add('selected');
            selectedTime = time;
        }

        async function bookAppointment(e) {
            e.preventDefault();
            
            const formData = {
                clinic_name: document.getElementById('clinicName').textContent,
                clinic_type: document.getElementById('clinicType').value,
                service: document.getElementById('service').value,
                appointment_date: document.getElementById('appointmentDate').value,
                appointment_time: selectedTime,
                notes: document.getElementById('notes').value
            };

            // Validate form
            if (!formData.clinic_type || !formData.service || !formData.appointment_date || !selectedTime) {
                showError('Please fill in all required fields');
                return;
            }

            showLoading(true);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    // Store appointment data for confirmation page
                    const appointmentData = {
                        id: result.id,
                        clinic_name: formData.clinic_name,
                        clinic_type: formData.clinic_type,
                        service: formData.service,
                        appointment_date: formData.appointment_date,
                        appointment_time: formData.appointment_time,
                        status: 'scheduled',
                        notes: formData.notes
                    };
                    localStorage.setItem('lastAppointment', JSON.stringify(appointmentData));
                    
                    // Redirect to confirmation page
                    window.location.href = `appointment-confirmation.html?id=${result.id}`;
                } else {
                    showError(result.error || 'Failed to book appointment');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('appointmentForm').style.display = show ? 'none' : 'block';
        }

        function showSuccess(message) {
            document.getElementById('successText').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
